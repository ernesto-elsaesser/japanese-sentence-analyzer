<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japanese Morphological Analyzer</title>
    <script src="kuromoji.js"></script>
    <style>
        form {
            display: flex;
            margin-bottom: 10px;
        }
        textarea {
            flex-grow: 1;
        }
        button {
            font-size: 18px;
            margin-left: 5px;
        }
        th, td {
            border: 1px solid;
            padding: 5px 10px;
        }
        a {
            text-decoration: none;
        }
    </style>
</head>
<body>

    <form>
        <textarea id="input" cols="64"></textarea>
        <button type="button" id="clear" onclick="clear()">X</button>
        <button type="button" id="run" disabled>RUN</button>
    </form>

    <table>
        <tbody id="output">
        </tbody>
    </table>

    <script>

        // see also https://www.sketchengine.eu/tagset-jp-mecab/
        const TAGS = {
            '動詞': 'verb',
            '名詞': 'noun',
            '形容詞': 'adjective',
            '代名詞': 'pronoun',
            '副詞': 'adverb',
            '連体詞': 'adnominal',
            '助動詞': 'auxiliary verb',
            '助詞': 'particle',
            '感動詞': 'interjection',
            '接頭辞': 'prefix',
            '接続詞': 'conjunction',
            '接尾辞': 'suffix',
            '空白': 'whitespace',
            '補助記号': 'supplementary symbol',
            '記号': 'symbol',

            "一般": "general",
            "人名": "name",
            "助数詞": "counter",
            "固有名詞": "proper",
            "係助詞": "binding",
            "格助詞": "case",
            "並立助詞": "connecting",
            "接続助詞": "conjunctive",
            "自立": "independent",
            "非自立": "dependent",
            "非自立可能": "bound",
            "副詞可能": "adverbial",
            "準体助詞": "nominal",
            "名詞的": "nominal",
            "動詞的": "verbal",
            "連体化": "noun-modifying",
            "助動詞語幹": "auxiliary",
            "引用": "quotative",
            "サ変接続": "suru-verbal",
            "終助詞": "phrase-final",
            "地域": "toponym",
            "句点": "period",
        }

        const INFLECTIONS = {
            '語幹': 'stem',
            '未然形': 'negative base',
            '意志推量形': 'volitive base',
            '連用形': 'masu base',
            '連用タ接続': 'te base',
            '終止形': 'terminal form',
            '基本形': 'regular form',
            '已然形': 'positive base',
            '連体形': 'attributive base',
            '仮定形': 'hypothetic base',
            '命令形': 'imperative base',
            'ク語法': 'nominalized "ku" form',
        }

        const input = document.getElementById("input")
        const button = document.getElementById("run")
        const output = document.getElementById("output")

        function present(tokens) {
            let rows = ""

            for (let token of tokens) {
                const surface_form = token["surface_form"]
                const reading = token["reading"] || ""
                const pos = token["pos"]
                const pos1 = token["pos_detail_1"]
                const pos2 = token["pos_detail_2"]
                const pos3 = token["pos_detail_3"]
                const conjugated_form = token["conjugated_form"]
                const basic_form = token["basic_form"]
                const conjugated_type = token["conjugated_type"]

                const query = basic_form == "*" ? surface_form : basic_form
                const jisho_link = "https://jisho.org/search/" + query

                const code = surface_form.charCodeAt(0)
                const is_kanji = (code >= 0x4E00 && code <= 0x9FFF)

                rows += '<tr><td><a href="' + jisho_link + '">' + surface_form + "</a>"
                if (is_kanji) rows += "<br/>" + reading
                rows += "</td>"

                pos_en = TAGS[pos]
                pos_jp = pos
                if (pos1 != "*") pos_en += ", " + TAGS[pos1]
                if (pos1 != "*") pos_jp += ", " + pos1
                if (pos2 != "*") pos_en += ", " + TAGS[pos2]
                if (pos2 != "*") pos_jp += ", " + pos2
                if (pos3 != "*") pos_en += ", " + TAGS[pos3]
                if (pos3 != "*") pos_jp += ", " + pos3
                rows += "<td>" + pos_en + "<br/>" + pos_jp
                if (conjugated_type != "*") {
                    rows += "<br/>" + INFLECTIONS[conjugated_form] + " of " + basic_form + " (" + conjugated_type + ")"
                }
                rows += "</td></tr>"
            }
            output.innerHTML = rows
        }
        
        function clear() {
            input.value = ""
        }

        kuromoji.builder({ dicPath: "dict" }).build(function (err, tokenizer) {
            button.onclick = function() {
                const sentence = input.value.replace(/\s/g, "")
                const tokens = tokenizer.tokenize(sentence)
                present(tokens)
            }
            button.disabled = false
        });

    </script>
</body>